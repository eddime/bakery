#pragma once
#include "webview/webview.h"
#ifdef __APPLE__
#include <objc/runtime.h>
#include <objc/message.h>
#include <pthread.h>
#include <mach/mach.h>
#include <mach/thread_policy.h>
#include <sys/resource.h>
namespace bakery{namespace ultra{inline void setHighPriority(){setpriority(PRIO_PROCESS,0,-20);thread_time_constraint_policy_data_t p;p.period=0;p.computation=5000000;p.constraint=10000000;p.preemptible=0;thread_policy_set(pthread_mach_thread_np(pthread_self()),THREAD_TIME_CONSTRAINT_POLICY,(thread_policy_t)&p,THREAD_TIME_CONSTRAINT_POLICY_COUNT);id pi=((id(*)(id,SEL))objc_msgSend)((id)objc_getClass("NSProcessInfo"),sel_registerName("processInfo"));unsigned long long ao=(1ULL<<40)|(1ULL<<20)|(1ULL<<14)|(1ULL<<15)|0xFF00000000ULL;id rs=((id(*)(id,SEL,const char*))objc_msgSend)((id)objc_getClass("NSString"),sel_registerName("stringWithUTF8String:"),"Bakery");id a=((id(*)(id,SEL,unsigned long long,id))objc_msgSend)(pi,sel_registerName("beginActivityWithOptions:reason:"),ao,rs);static id sa=a;((void(*)(id,SEL))objc_msgSend)(sa,sel_registerName("retain"));}inline void enableMetalRendering(webview::webview&w){auto wr=w.window();if(!wr.has_value())return;void*nw=(void*)wr.value();if(!nw)return;id cv=((id(*)(id,SEL))objc_msgSend)((id)nw,sel_registerName("contentView"));if(cv){((void(*)(id,SEL,BOOL))objc_msgSend)(cv,sel_registerName("setWantsLayer:"),YES);((void(*)(id,SEL,BOOL))objc_msgSend)((id)nw,sel_registerName("setOpaque:"),YES);((void(*)(id,SEL,double))objc_msgSend)(cv,sel_registerName("setLayerContentsRedrawPolicy:"),2.0);}}inline void enableUltraPerformance(webview::webview&w){setHighPriority();enableMetalRendering(w);w.init("Object.defineProperty(document,'hidden',{get:()=>false,configurable:false});Object.defineProperty(document,'visibilityState',{get:()=>'visible',configurable:false});Object.defineProperty(document,'webkitHidden',{get:()=>false});Object.defineProperty(document,'webkitVisibilityState',{get:()=>'visible'});const oAEL=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(t,l,o){if(['visibilitychange','webkitvisibilitychange','blur','pagehide'].includes(t))return;return oAEL.call(this,t,l,o);};const oST=window.setTimeout,oSI=window.setInterval;window.setTimeout=function(c,d,...a){return oST.call(window,c,d,...a);};window.setInterval=function(c,d,...a){return oSI.call(window,c,d,...a);};oSI.call(window,()=>performance.now(),100);if(navigator.wakeLock)navigator.wakeLock.request('screen').catch(()=>{});Object.defineProperty(document,'hasFocus',{value:()=>true});setTimeout(()=>{try{if(window.AudioContext||window.webkitAudioContext){const AC=window.AudioContext||window.webkitAudioContext,ctx=new AC,osc=ctx.createOscillator(),gain=ctx.createGain();gain.gain.value=0.0001;osc.connect(gain);gain.connect(ctx.destination);osc.start();setInterval(()=>{if(ctx.state==='suspended')ctx.resume();},1000);}}catch(e){}},1000);(()=>requestAnimationFrame(arguments.callee))();setTimeout(()=>{const s=document.createElement('style');s.textContent='html,body{will-change:transform,opacity,contents!important;transform:translateZ(0)!important;backface-visibility:hidden!important;perspective:1000px!important}canvas,#game-container,#phaser-game{will-change:transform,contents!important;transform:translate3d(0,0,0)!important;backface-visibility:hidden!important;isolation:isolate!important;contain:layout style paint!important}*{contain:layout paint!important}';document.head.appendChild(s);const c=document.createElement('canvas');c.width=c.height=1;c.style.cssText='position:fixed;left:-9999px';const gl=c.getContext('webgl2',{powerPreference:'high-performance',antialias:false,alpha:false,desynchronized:true,preserveDrawingBuffer:false});if(gl){const r=()=>{gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);gl.flush();requestAnimationFrame(r);};r();}const oRAF=window.requestAnimationFrame;let rcs=[],sch=false;window.requestAnimationFrame=function(cb){rcs.push(cb);if(!sch){sch=true;oRAF.call(window,t=>{sch=false;const c=rcs;rcs=[];c.forEach(f=>{try{f(t)}catch(e){}});})}return 0;};const oGBCR=Element.prototype.getBoundingClientRect;Element.prototype.getBoundingClientRect=function(){return oGBCR.call(this);};},100);let rp=0;const hpr=()=>{rp++;if(rp%2===0){const d=document.documentElement.scrollTop;}requestAnimationFrame(hpr);};hpr();if(window.gc)window.gc=function(){};const mp={arrays:Array(100).fill(null).map(()=>new Float32Array(1000)),objects:Array(100).fill(null).map(()=>({}))};let lf=performance.now(),fc=0,fs=performance.now();const oRAF2=window.requestAnimationFrame;window.requestAnimationFrame=function(cb){return oRAF2.call(window,function(t){lf=t;fc++;if(t-fs>=1000){fc=0;fs=t;}cb(t);});};window.__bakeryDebugFPS=false;const cv=document.createElement('canvas'),gl=cv.getContext('webgl2',{powerPreference:'high-performance',antialias:false,alpha:false,depth:true,stencil:false,preserveDrawingBuffer:false,desynchronized:true,failIfMajorPerformanceCaveat:false,xrCompatible:false});if(gl){gl.hint(gl.FRAGMENT_SHADER_DERIVATIVE_HINT,gl.FASTEST);gl.hint(gl.GENERATE_MIPMAP_HINT,gl.FASTEST);gl.disable(gl.DITHER);gl.disable(gl.SAMPLE_ALPHA_TO_COVERAGE);}const cs=document.createElement('style');cs.textContent='canvas{will-change:transform,contents;transform:translateZ(0);image-rendering:-webkit-optimize-contrast;image-rendering:pixelated}body,html{overscroll-behavior:none;scroll-behavior:auto!important;-webkit-font-smoothing:subpixel-antialiased}*{-webkit-transform:translateZ(0);transform:translateZ(0)}';document.head.appendChild(cs);if('decode' in HTMLImageElement.prototype){const oSS=Object.getOwnPropertyDescriptor(HTMLImageElement.prototype,'src').set;Object.defineProperty(HTMLImageElement.prototype,'src',{set:function(v){this.loading='eager';this.decoding='async';oSS.call(this,v);this.decode().catch(()=>{});},configurable:true});}if(window.AudioContext||window.webkitAudioContext){const OAC=window.AudioContext||window.webkitAudioContext;window.AudioContext=window.webkitAudioContext=function(...a){const c=new OAC(...a);if(c.state==='suspended')c.resume();const oS=c.suspend.bind(c);c.suspend=function(){return Promise.resolve();};return c;};}if(!window.performance||!window.performance.now)window.performance={now:function(){return Date.now();}};let pu=[],us=false;window.batchUpdate=function(fn){pu.push(fn);if(!us){us=true;requestAnimationFrame(()=>{const u=pu;pu=[];us=false;u.forEach(f=>f());});}};const et=['touchstart','touchmove','touchend','mousedown','mousemove','mouseup','pointerdown','pointermove','pointerup','wheel','keydown','keyup','keypress'];const oAEL2=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(t,l,o){if(et.includes(t)){if(typeof o==='object')o.passive=false;else o={passive:false,capture:!!o};}return oAEL2.call(this,t,l,o);};window.lockPointer=function(el){el=el||document.body;el.requestPointerLock=el.requestPointerLock||el.mozRequestPointerLock||el.webkitRequestPointerLock;if(el.requestPointerLock)el.requestPointerLock();};let is={keys:{},mouse:{x:0,y:0,buttons:0},touch:[]};document.addEventListener('keydown',e=>is.keys[e.code]=true,{passive:false,capture:true});document.addEventListener('keyup',e=>is.keys[e.code]=false,{passive:false,capture:true});document.addEventListener('mousemove',e=>{is.mouse.x=e.clientX;is.mouse.y=e.clientY;},{passive:false,capture:true});document.addEventListener('mousedown',e=>is.mouse.buttons|=(1<<e.button),{passive:false,capture:true});document.addEventListener('mouseup',e=>is.mouse.buttons&=~(1<<e.button),{passive:false,capture:true});window.getInputState=()=>is;const mv=document.createElement('meta');mv.name='viewport';mv.content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui';if(document.head&&!document.querySelector('meta[name=\"viewport\"]'))document.head.appendChild(mv);const ts=document.createElement('style');ts.textContent='*{touch-action:none!important;-webkit-tap-highlight-color:transparent!important;-webkit-touch-callout:none!important;-webkit-user-select:none!important;user-select:none!important}';document.head.appendChild(ts);if(window.PointerEvent){const oGCE=PointerEvent.prototype.getCoalescedEvents;if(oGCE)PointerEvent.prototype.getCoalescedEvents=function(){return[this];};}window.enablePredictiveInput=function(){let lit=performance.now(),ih=[],mh=10;document.addEventListener('mousemove',e=>{const n=performance.now(),d=n-lit;ih.push({x:e.clientX,y:e.clientY,time:n,delta:d});if(ih.length>mh)ih.shift();lit=n;if(ih.length>=2){const l=ih[ih.length-1],p=ih[ih.length-2],vx=(l.x-p.x)/l.delta,vy=(l.y-p.y)/l.delta;e.predictedX=l.x+vx*8;e.predictedY=l.y+vy*8;}},{passive:false,capture:true});};");}}}
#elif defined(_WIN32)
#include <windows.h>
namespace bakery{namespace ultra{inline void setHighPriority(){SetPriorityClass(GetCurrentProcess(),HIGH_PRIORITY_CLASS);SetThreadPriority(GetCurrentThread(),THREAD_PRIORITY_TIME_CRITICAL);}inline void enableUltraPerformance(webview::webview&w){setHighPriority();w.init("");}}}
#else
#include <sys/resource.h>
#include <pthread.h>
namespace bakery{namespace ultra{inline void setHighPriority(){setpriority(PRIO_PROCESS,0,-20);struct sched_param p;p.sched_priority=sched_get_priority_max(SCHED_FIFO);pthread_setschedparam(pthread_self(),SCHED_FIFO,&p);}inline void enableUltraPerformance(webview::webview&w){setHighPriority();w.init("");}}}
#endif
